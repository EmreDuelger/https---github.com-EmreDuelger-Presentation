name: Auto PR erstellen + Auto-Merge aktivieren

on:
  push:
    branches:
      - 'claude/**'
      - 'dependabot/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    name: Pull Request erstellen
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: PR erstellen oder finden
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
          BRANCH: ${{ github.ref_name }}
        run: |
          # Pr√ºfe ob PR bereits existiert
          EXISTING_URL=$(gh pr list --head "$BRANCH" --state open --json url --jq '.[0].url // empty')

          if [ -n "$EXISTING_URL" ]; then
            echo "PR existiert bereits: $EXISTING_URL"
            echo "url=$EXISTING_URL" >> "$GITHUB_OUTPUT"
          else
            echo "Erstelle neuen PR..."

            TITLE=$(echo "$BRANCH" | sed 's|claude/||' | sed 's|-| |g')
            COMMITS=$(git log origin/master..HEAD --pretty=format:"- %s" 2>/dev/null || echo "- Neue Aenderungen")

            BODY="## Automatisch erstellter PR"
            BODY="$BODY\n\nBranch: \`$BRANCH\`"
            BODY="$BODY\n\n### Commits\n$COMMITS"

            echo -e "$BODY" > /tmp/pr-body.md

            NEW_URL=$(gh pr create \
              --base master \
              --title "$TITLE" \
              --body-file /tmp/pr-body.md 2>&1 | tail -1)

            echo "PR erstellt: $NEW_URL"
            echo "url=$NEW_URL" >> "$GITHUB_OUTPUT"
          fi

      - name: Auto-Merge aktivieren
        if: steps.pr.outputs.url != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_URL="${{ steps.pr.outputs.url }}"
          PR_NUMBER=$(basename "$PR_URL")
          echo "Aktiviere Auto-Merge fuer PR #$PR_NUMBER: $PR_URL"

          # --auto wartet auf Branch Protection Rules
          gh pr merge "$PR_URL" --auto --squash || echo "Auto-Merge konnte nicht aktiviert werden. Ist 'Allow auto-merge' aktiviert?"

      - name: Checks manuell triggern  # ‚Üê DIE MAGISCHE STEP!
        if: steps.pr.outputs.url != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=$(basename "${{ steps.pr.outputs.url }}")
          echo "üîÑ Trigger alle Checks fuer PR #$PR_NUMBER..."
          
          # Re-run ALLE Checks f√ºr diesen PR
          gh pr checks "$PR_NUMBER" --rerun
          echo "‚úÖ Alle Checks getriggert! Auto-Merge wartet..."
