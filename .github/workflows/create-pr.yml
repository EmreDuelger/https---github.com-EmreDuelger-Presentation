name: Auto PR erstellen

on:
  push:
    branches:
      - 'claude/**'
      - 'dependabot/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    name: Pull Request erstellen
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: PrÃ¼fe ob PR bereits existiert
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          EXISTING=$(gh pr list --head "${{ github.ref_name }}" --state open --json number --jq 'length')
          echo "existing=$EXISTING" >> "$GITHUB_OUTPUT"

      - name: PR erstellen
        if: steps.check.outputs.existing == '0'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BRANCH="${{ github.ref_name }}"
          TITLE=$(echo "$BRANCH" | sed 's|claude/||' | sed 's|-| |g')
          COMMITS=$(git log origin/master..HEAD --pretty=format:"- %s" 2>/dev/null || echo "- Neue Aenderungen")

          BODY="## Automatisch erstellter PR"
          BODY="$BODY\n\nBranch: \`$BRANCH\`"
          BODY="$BODY\n\n### Commits\n$COMMITS"
          BODY="$BODY\n\n### Pipeline"
          BODY="$BODY\n- [ ] CI-Agent: HTML-Validierung + Link-Check"
          BODY="$BODY\n- [ ] Auto-Merge nach bestandenen Checks"
          BODY="$BODY\n- [ ] Pages-Deploy nach Merge"

          echo -e "$BODY" > /tmp/pr-body.md

          gh pr create \
            --base master \
            --title "$TITLE" \
            --body-file /tmp/pr-body.md

          echo "PR erstellt fuer Branch: $BRANCH"
